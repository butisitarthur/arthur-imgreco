version: '3.8'

services:
    # Main application
    arthur-imgreco:
        build: .
        ports:
            - '${APP_PORT:-8000}:8000'
        environment:
            - DATABASE_URL=postgresql://arthur:arthur123@postgres:5432/arthur_imgreco
            - REDIS_URL=redis://redis:6379
            - QDRANT_URL=http://qdrant:6333
            - LOG_LEVEL=INFO
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            qdrant:
                condition: service_started
        volumes:
            - ./data:/app/data
            - ./logs:/app/logs
        networks:
            - arthur-network
        restart: unless-stopped

    # PostgreSQL database
    postgres:
        image: pgvector/pgvector:pg17
        environment:
            - POSTGRES_DB=arthur_imgreco
            - POSTGRES_USER=arthur
            - POSTGRES_PASSWORD=arthur123
        ports:
            - '${DB_PORT:-5432}:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U arthur -d arthur_imgreco']
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - arthur-network
        restart: unless-stopped

    # Redis cache
    redis:
        image: redis:7-alpine
        ports:
            - '${REDIS_PORT:-6379}:6379'
        volumes:
            - redis_data:/data
        command: redis-server --appendonly yes
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - arthur-network
        restart: unless-stopped

    # Qdrant vector database
    qdrant:
        image: qdrant/qdrant:v1.12.1
        ports:
            - '${QDRANT_PORT:-6333}:6333'
            - '${QDRANT_GRPC_PORT:-6334}:6334'
        volumes:
            - qdrant_data:/qdrant/storage
        environment:
            - QDRANT__SERVICE__HTTP_PORT=6333
            - QDRANT__SERVICE__GRPC_PORT=6334
        networks:
            - arthur-network
        restart: unless-stopped

    # Celery worker for background tasks
    celery-worker:
        build: .
        command: celery -A arthur_imgreco.core.celery worker --loglevel=info
        environment:
            - DATABASE_URL=postgresql://arthur:arthur123@postgres:5432/arthur_imgreco
            - REDIS_URL=redis://redis:6379
            - QDRANT_URL=http://qdrant:6333
        depends_on:
            - postgres
            - redis
            - qdrant
        volumes:
            - ./data:/app/data
            - ./logs:/app/logs
        networks:
            - arthur-network
        restart: unless-stopped

    # Nginx reverse proxy
    nginx:
        image: nginx:alpine
        ports:
            - '${NGINX_PORT:-80}:80'
        volumes:
            - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        depends_on:
            - arthur-imgreco
        networks:
            - arthur-network
        restart: unless-stopped

    # Prometheus monitoring
    prometheus:
        image: prom/prometheus:latest
        ports:
            - '${PROMETHEUS_PORT:-9090}:9090'
        volumes:
            - ./docker/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--web.enable-lifecycle'
        networks:
            - arthur-network
        restart: unless-stopped

    # Grafana dashboards
    grafana:
        image: grafana/grafana:latest
        ports:
            - '${GRAFANA_PORT:-3000}:3000'
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin123
        volumes:
            - grafana_data:/var/lib/grafana
            - ./docker/grafana/provisioning:/etc/grafana/provisioning:ro
        depends_on:
            - prometheus
        networks:
            - arthur-network
        restart: unless-stopped

volumes:
    postgres_data:
    redis_data:
    qdrant_data:
    prometheus_data:
    grafana_data:

networks:
    arthur-network:
        driver: bridge
